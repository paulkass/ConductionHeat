<!DOCTYPE html>
<html lang="en">
    <head>
        <title>HackingEDU Project</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="assets/audiolib.js"></script>
		<script src="Flocking/dist/flocking-all.js"></script>
		<script src="timer-stopwatch-1/index.js"></script>
		<script src="index.js"></script>
		<script src="tuna/tuna.js"></script>
		<script src="jasmid/midifile.js"></script>
		<script src="jasmid/stream.js"></script>
		<script src="jasmid/replayer.js"></script>
		<script src="jasmid/synth.js"></script>
		<script src="jasmid/audio.js"></script>
		<script src="MIDI.js/inc/shim/Base64.js" type="text/javascript"></script>
		<script src="MIDI.js/inc/shim/Base64binary.js" type="text/javascript"></script>
		<script src="MIDI.js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
		<script src="MIDI.js/build/MIDI.js" type="text/javascript"></script>
		<script src="MIDI.js/js/util/dom_request_xhr.js" type="text/javascript"></script>
		<script src="MIDI.js/js/util/dom_request_script.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/audioDetect.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/gm.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/loader.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
		<script src="MIDI.js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
		<!-- // <script src="MIDI.js/js/midi/audiodetect.js" type="text/javascript"></script>
// 		<script src="MIDI.js/js/midi/loadplugin.js" type="text/javascript"></script>
// 		<script src="MIDI.js/js/midi/plugin.js" type="text/javascript"></script>
// 		<script src="MIDI.js/js/midi/player.js" type="text/javascript"></script>
// 		<script src="MIDI.js/js/midi/loader.js" type="text/javascript"></script> -->
		<script src="leapinterp.js" type="text/javascript"></script>
    </head>
    <body>
       <p id="hand"></p>
       <p id="pause"></p>
	   <button onClick="replay();">Pause</button> 
	   <button onClick="slowdown_player(3);">Slowdown</button>
	   <button onClick="change_volume(volume)">Louder</button>
	   <p id="data"></p>
	   <p id="data_2"></p>
	           <script>
	   // var volume = 1.05;
	   var env = flock.init();
	   env.start();
	   
	   window.onload = function() {
		   playNextNote(0);
		   playNextNote(1);
	   }
// 	   var synth = flock.synth({
// 		   synthDef: {
// 			   id: "carrier1",
// 			   ugen: "flock.ugen.sinOsc",
// 			   freq: 296,
// 			   mul: 0.5
// 		   }
// 	   });
//
// 	   function change_volume(vol) {
// 	   		synth.set("carrier1.mul", synth.get("carrier1.mul")*vol)
// 		   //synth.set("carrier1.freq", Math.pow(2, 1/12)*synth.get("carrier1.freq"))
// 		   //alert(vol)
// 	   }
	   
	  			function loadRemote(path, callback) {
	   				var fetch = new XMLHttpRequest();
	   				fetch.open('GET', path);
	   				fetch.overrideMimeType("text/plain; charset=x-user-defined");
	   				fetch.onreadystatechange = function() {
	   					if(this.readyState == 4 && this.status == 200) {
	   						/* munge response into a binary string */
	   						var t = this.responseText || "" ;
	   						var ff = [];
	   						var mx = t.length;
	   						var scc= String.fromCharCode;
	   						for (var z = 0; z < mx; z++) {
	   							ff[z] = scc(t.charCodeAt(z) & 255);
	   						}
	   						callback(ff.join(""));
	   					}
	   				}
	   				fetch.send();
	   			}
				player = MIDI.Player;
				
				function slowdown_player(factor) {
					MIDI.setEffects({
						        type: "Delay",
						        feedback: 0.45, // 0 to 1+
						        delayTime: 150, // how many milliseconds should the wet signal be delayed? 
						        wetLevel: 0.25, // 0 to 1+
						        dryLevel: 1, // 0 to 1+
						        cutoff: 20, // cutoff frequency of the built in highpass-filter. 20 to 22050
						        bypass: 0
						    });
				}
				
				function replay() {
					replayer.replay(audio);
				}
				var replayer, audio;
				function getAmplitude() {
					return 0.1;
				}
	   		// $(document).ready(function() {
// 				MIDI.loadPlugin({
// 					soundfontUrl: "assets/midi-js-soundfonts/FluidR3_GM/",
// 					instrument: ["acoustic_grand_piano"],
// 					onprogress: function(state, progress) {
// 						console.log(state, progress);
// 					},
//     				onsuccess: function() {
// 						var delay = 1; // play one note every quarter second
// 						var note = 50; // the MIDI note
// 						var velocity = 127; // how hard the note hits
// 									// play the note
// 						// MIDI.setVolume(0, 127);
// // 						MIDI.chordOn(0, [50, 55, 60], velocity, delay);
// // 						MIDI.noteOff(0, note, delay + 0.75);
// 						// loadRemote("cathedral.mid", function(data){
// // 							 //alert(btoa(data).toString())
// // 							$("#data").text(JSON.stringify(MidiFile(data)));
// // 							 player = MIDI.Player;
// // 							 player.timeWarp = 1;
// // 							player.loadFile('data:audio/mid;base64, '+btoa(data), player.start, function(){}, function(err){alert(JSON.stringify(err));})
// // 						});
// 						loadRemote("cathedral.mid", function(data) {
// 							midiFile = MidiFile(data);
// 							synth = Synth(44100);
// 							replayer = Replayer(midiFile, synth);
// 							return_data = replayer.generate(4096*4)
// 							for (i=0; i<return_data.length; i++) {
// 								return_data[i] = 2*return_data[i]
// 							}
//
// 							var webkitAudio = var webkitAudio = window.AudioContext || window.webkitAudioContext;
//
// 							var context = new webkitAudio();
// 							sampleRate = context.sampleRate;
//
// 							var channelCount = 2;
// 							var bufferSize = 4096*4; // Higher for less gitches, lower for less latency
//
// 							var node = context.createScriptProcessor(bufferSize, 0, channelCount);
//
// 							node.onaudioprocess = function(e) { process(e) };
//
//
// 							function process(e) {
//
// 								var dataLeft = e.outputBuffer.getChannelData(0);
// 								var dataRight = e.outputBuffer.getChannelData(1);
//
// 								var generate = return_data;
//
// 								for (var i = 0; i < bufferSize; ++i) {
// 									//alert(generate[i*2])
// 									dataLeft[i] = generate[i*2];
// 									dataRight[i] = generate[i*2+1];
// 								}
// 							}
//
// 							// start
// 							node.connect(context.destination);
//
// 							//alert("hi")
// 							//audio = AudioPlayer(replayer);
// 						});
						// loadRemote("cathedral.mid", function(data){
// 							//alert(btoa(data).toString())
// 							$("#data").text(JSON.stringify(MidiFile(data)));
// 	 					   	var note_data = MidiFile(data);
// 							var note_data_array  = {
// 								data: []
// 							};
// 							for (var i=1; i<note_data.tracks.length; i++) {
// 								var track = note_data.tracks[i];
// 								note_data_array.data.push(track)
// 							}
// 							for (var i=0; i<note_data_array.data.length; i++) {
// 								var track = note_data_array.data[i];
// 								alert(JSON.stringify(track))
// 								var l=0;
// 								while (track.length!=0) {
// 									//alert("hi")
// 									var command = track[l]
// 									var t = 0
// 									var eval_string = ""
// 									if (command.subtype=="noteOn") {
//
// 										t = track[0].deltaTime
// 										eval_string = "MIDI.noteOn("+command.channel+", "+command.noteNumber+", "+command.velocity+", 0)";
// 									} else if (command.subtype=="noteOff") {
// 										t = track[0].deltaTime
// 										eval_string = "MIDI.noteOff("+command.channel+", "+command.noteNumber+", 0)";
// 									}
// 									setTimeout(function() {
// 										//alert(eval_string)
// 										eval(eval_string)
// 									}, t);
// 								}
// 								//alert("hi")
// 							}
// 							$("#data_2").text(JSON.stringify(note_data_array));
// 					  	});
//						}
//					});

//	   		});	
	   		</script>
    </body>
</html>
